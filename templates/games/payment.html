<!DOCTYPE html>
{% extends 'company/base.html' %}

{% block title %}Payment - VUM Games{% endblock %}

{% block extra_css %}
<style>
    .payment-container {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        padding: 2.5rem;
        margin: 2rem 0;
    }
    
    .payment-summary {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        padding: 2rem;
        position: sticky;
        top: 100px;
    }
    
    #card-element {
        background: rgba(0, 102, 255, 0.05);
        padding: 16px;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        transition: border-color 0.3s ease;
    }

    .StripeElement--focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
    }
    
    .payment-method-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        border-bottom: 2px solid var(--border-color);
        flex-wrap: wrap;
    }
    
    .payment-method-tab {
        padding: 1rem 1.5rem;
        border: none;
        background: none;
        color: var(--text-secondary);
        font-weight: 600;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
        font-size: 0.95rem;
    }
    
    .payment-method-tab.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
    }
    
    .payment-method-tab:hover:not(.active) {
        color: var(--text-primary);
    }
    
    .security-badges {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1.5rem;
        flex-wrap: wrap;
        margin-top: 1rem;
    }
    
    .security-badge {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(10, 14, 26, 0.95);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        backdrop-filter: blur(10px);
    }
    
    .loading-content {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        padding: 3rem;
        border-radius: 20px;
        text-align: center;
        max-width: 400px;
    }
    
    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid var(--border-color);
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1.5rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .detail-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 0;
        color: var(--text-secondary);
    }

    .detail-row i {
        color: var(--primary-color);
    }

    .cash-info-box {
        background: rgba(255, 193, 7, 0.1);
        border: 2px solid #ffc107;
        border-radius: 16px;
        padding: 1.5rem;
        margin-top: 1rem;
    }

    .cash-info-box h6 {
        color: #ffc107;
        font-weight: 700;
        margin-bottom: 1rem;
    }

    .cash-info-box ul {
        margin: 0;
        padding-left: 1.5rem;
        color: var(--text-secondary);
    }

    .cash-info-box li {
        margin-bottom: 0.5rem;
    }

    #paypal-button-container {
        margin-top: 1rem;
    }

    .revolut-pay-button {
        background: #000;
        color: #fff;
        border: none;
        padding: 16px 24px;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .revolut-pay-button:hover {
        background: #222;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb" style="background: transparent; padding: 0; margin: 0;">
                    <li class="breadcrumb-item"><a href="{% url 'home' %}" style="color: var(--text-secondary); text-decoration: none;">Home</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'sessions_list' %}" style="color: var(--text-secondary); text-decoration: none;">Sessions</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'book_session' booking.session.id %}" style="color: var(--text-secondary); text-decoration: none;">Booking</a></li>
                    <li class="breadcrumb-item active" style="color: var(--text-primary);">Payment</li>
                </ol>
            </nav>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <div class="payment-container">
                <h2 style="color: var(--text-primary); margin-bottom: 2rem; font-weight: 800; font-size: 2rem;">
                    <i class="fas fa-credit-card me-2" style="color: var(--primary-color);"></i>
                    Complete Your Payment
                </h2>
                
                <div class="payment-method-tabs">
                    <button class="payment-method-tab active" data-method="card">
                        <i class="fas fa-credit-card me-2"></i>Card
                    </button>
                    <button class="payment-method-tab" data-method="revolut">
                        <i class="fas fa-bolt me-2"></i>Revolut
                    </button>
                    <button class="payment-method-tab" data-method="paypal">
                        <i class="fab fa-paypal me-2"></i>PayPal
                    </button>
                    <button class="payment-method-tab" data-method="cash">
                        <i class="fas fa-money-bill-wave me-2"></i>Cash at Event
                    </button>
                </div>
                
                <!-- Card payment section -->
                <div class="payment-method-content" id="card-method">
                    <form id="card-payment-form">
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Name on Card</label>
                                <input type="text" class="form-control" id="cardholder-name" name="cardholder_name" placeholder="Full name" value="{{ booking.customer_name|default:'' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email for Receipt</label>
                                <input type="email" class="form-control" id="email" name="email" value="{{ booking.customer_email }}">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-credit-card me-1"></i>Card Information
                            </label>
                            <div id="card-element"></div>
                            <div id="card-errors" class="text-danger mt-2" style="color: var(--accent-color) !important;"></div>
                        </div>
                    
                        <div class="mb-4 p-3" style="background: rgba(0, 217, 255, 0.05); border-radius: 16px; border: 1px solid var(--border-color);">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h6 style="color: var(--text-primary); margin-bottom: 0.5rem; font-weight: 700;">
                                        <i class="fas fa-shield-alt me-2" style="color: var(--secondary-color);"></i>
                                        Secure Payment
                                    </h6>
                                    <small style="color: var(--text-secondary);">Your payment information is encrypted and secure</small>
                                </div>
                                <div class="col-md-6">
                                    <div class="security-badges">
                                        <div class="security-badge">
                                            <i class="fab fa-cc-visa"></i>Visa
                                        </div>
                                        <div class="security-badge">
                                            <i class="fab fa-cc-mastercard"></i>Mastercard
                                        </div>
                                        <div class="security-badge">
                                            <i class="fas fa-lock"></i>SSL
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <a href="{% url 'book_session' booking.session.id %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Booking
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <span><i class="fas fa-lock me-2"></i>Pay €{{ booking.total_price }}</span>
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Revolut payment section -->
                <div class="payment-method-content" id="revolut-method" style="display: none;">
                    <form id="revolut-payment-form">
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" id="revolut-name" name="name" placeholder="Full name" value="{{ booking.customer_name|default:'' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email for Receipt</label>
                                <input type="email" class="form-control" id="revolut-email" name="email" value="{{ booking.customer_email }}">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-bolt me-1"></i>Revolut Pay
                            </label>
                            <div id="revolut-card-field"></div>
                            <div id="revolut-errors" class="text-danger mt-2" style="color: var(--accent-color) !important;"></div>
                        </div>
                    
                        <div class="mb-4 p-3" style="background: rgba(0, 0, 0, 0.3); border-radius: 16px; border: 1px solid var(--border-color);">
                            <div class="d-flex align-items-center gap-3">
                                <i class="fas fa-bolt" style="font-size: 2rem; color: #000;"></i>
                                <div>
                                    <h6 style="color: var(--text-primary); margin-bottom: 0.25rem; font-weight: 700;">
                                        Pay with Revolut
                                    </h6>
                                    <small style="color: var(--text-secondary);">Fast, secure payment with your Revolut account</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <a href="{% url 'book_session' booking.session.id %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Booking
                            </a>
                            <button type="submit" class="revolut-pay-button">
                                <i class="fas fa-bolt"></i>
                                <span>Pay €{{ booking.total_price }} with Revolut</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- PayPal payment section -->
                <div class="payment-method-content" id="paypal-method" style="display: none;">
                    <div class="mb-4 p-3" style="background: rgba(0, 48, 135, 0.1); border-radius: 16px; border: 1px solid var(--border-color);">
                        <div class="d-flex align-items-center gap-3">
                            <i class="fab fa-paypal" style="font-size: 2rem; color: #0070ba;"></i>
                            <div>
                                <h6 style="color: var(--text-primary); margin-bottom: 0.25rem; font-weight: 700;">
                                    Pay with PayPal
                                </h6>
                                <small style="color: var(--text-secondary);">You'll be redirected to PayPal to complete your payment</small>
                            </div>
                        </div>
                    </div>

                    <div id="paypal-button-container"></div>

                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mt-3">
                        <a href="{% url 'book_session' booking.session.id %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Booking
                        </a>
                    </div>
                </div>

                <!-- Cash payment section -->
                <div class="payment-method-content" id="cash-method" style="display: none;">
                    <form method="POST" id="cash-payment-form">
                        {% csrf_token %}
                        <input type="hidden" name="payment_method" value="cash">
                        
                        <div class="cash-info-box">
                            <h6>
                                <i class="fas fa-info-circle me-2"></i>
                                Pay with Cash at the Event
                            </h6>
                            <ul>
                                <li>Your booking will be confirmed immediately</li>
                                <li>Bring <strong>€{{ booking.total_price }}</strong> in cash to the event</li>
                                <li>Show your booking reference code when you arrive</li>
                                <li>Payment must be made before the session starts</li>
                            </ul>
                        </div>

                        <div class="mt-4 p-3 text-center" style="background: rgba(0, 102, 255, 0.05); border-radius: 12px; border: 1px solid var(--border-color);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Your Booking Reference</small>
                            <strong style="color: var(--text-primary); font-family: 'Courier New', monospace; font-size: 1.5rem;">{{ booking.booking_reference }}</strong>
                            <p style="color: var(--text-secondary); margin-top: 0.5rem; margin-bottom: 0;">Show this code at the event</p>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mt-4">
                            <a href="{% url 'book_session' booking.session.id %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Booking
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-check me-2"></i>Confirm Cash Payment
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="payment-summary">
                <h4 style="color: var(--text-primary); margin-bottom: 1.5rem; font-weight: 700;">
                    <i class="fas fa-receipt me-2"></i>Payment Summary
                </h4>
                
                <div class="session-details mb-4">
                    <h5 style="color: var(--text-primary); font-size: 1.25rem; margin-bottom: 1rem; font-weight: 700;">{{ booking.session.name }}</h5>
                    
                    <div class="detail-row">
                        <i class="fas fa-calendar"></i>
                        <span style="color: var(--text-primary);">{{ booking.session.date|date:"l, F d, Y" }}</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-clock"></i>
                        <span style="color: var(--text-primary);">{{ booking.session.start_time|time:"H:i" }} - {{ booking.session.end_time|time:"H:i" }}</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-users"></i>
                        <span style="color: var(--text-primary);">{{ booking.participants }} {% if booking.participants == 1 %}participant{% else %}participants{% endif %}</span>
                    </div>
                </div>
                
                <hr style="border-color: var(--border-color); margin: 1.5rem 0;">
                
                <div style="padding: 1.5rem; background: rgba(0, 102, 255, 0.05); border-radius: 16px; border: 1px solid var(--border-color);">
                    <div class="d-flex justify-content-between mb-2" style="color: var(--text-secondary);">
                        <span>{{ booking.participants }} × €{{ booking.session.price_per_person }}</span>
                        <span style="color: var(--text-primary); font-weight: 600;">€{{ booking.total_price }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3" style="color: var(--text-secondary);">
                        <span>Service fee</span>
                        <span style="color: var(--text-primary); font-weight: 600;">€0.00</span>
                    </div>
                    <hr style="border-color: var(--border-color);">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong style="color: var(--text-primary); font-size: 1.1rem;">Total</strong>
                        <strong style="color: var(--primary-color); font-size: 2rem;">€{{ booking.total_price }}</strong>
                    </div>
                </div>
                
                <div class="mt-3 p-3 text-center" style="background: rgba(0, 102, 255, 0.05); border-radius: 12px; border: 1px solid var(--border-color);">
                    <small style="color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Booking Reference</small>
                    <strong style="color: var(--text-primary); font-family: 'Courier New', monospace; font-size: 1.1rem;">{{ booking.booking_reference }}</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <h5 style="color: var(--text-primary); margin-bottom: 0.5rem; font-weight: 700;">Processing Payment...</h5>
        <p style="color: var(--text-secondary); margin: 0;">Please don't close this window</p>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&currency=EUR"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let paymentMethod = 'card';
    const loadingOverlay = document.getElementById('loading-overlay');

    // Handle payment method tabs
    document.querySelectorAll('.payment-method-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.payment-method-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.payment-method-content').forEach(c => c.style.display = 'none');
            this.classList.add('active');
            paymentMethod = this.dataset.method;
            document.getElementById(paymentMethod + '-method').style.display = 'block';
        });
    });

    {% if client_secret and stripe_public_key %}
    // Initialize Stripe
    const stripe = Stripe('{{ stripe_public_key }}');
    const elements = stripe.elements();

    // Create Card Element
    const cardElement = elements.create('card', {
        style: {
            base: {
                fontSize: '16px',
                color: '#FFFFFF',
                '::placeholder': { color: '#A0AEC0' },
                fontFamily: '"Inter", sans-serif',
            },
        },
    });
    cardElement.mount('#card-element');
    cardElement.on('change', ({error}) => {
        document.getElementById('card-errors').textContent = error ? error.message : '';
    });

    // Handle Card payment form submission
    document.getElementById('card-payment-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        loadingOverlay.style.display = 'flex';
        
        const email = document.getElementById('email').value;
        const name = document.getElementById('cardholder-name').value;

        if (!name || !email) {
            loadingOverlay.style.display = 'none';
            document.getElementById('card-errors').textContent = 'Please enter your name and email.';
            return;
        }

        const {error} = await stripe.confirmCardPayment('{{ client_secret }}', {
            payment_method: { 
                card: cardElement, 
                billing_details: { name: name, email: email } 
            }
        });
        
        if (error) {
            loadingOverlay.style.display = 'none';
            document.getElementById('card-errors').textContent = error.message;
        } else {
            window.location.href = '{% url "booking_success" booking.access_token %}';
        }
    });

    // Revolut Pay (using Stripe card element as placeholder)
    // Note: For actual Revolut integration, you'd need to use their SDK
    const revolutCardField = elements.create('card', {
        style: {
            base: {
                fontSize: '16px',
                color: '#FFFFFF',
                '::placeholder': { color: '#A0AEC0' },
                fontFamily: '"Inter", sans-serif',
            },
        },
    });
    revolutCardField.mount('#revolut-card-field');

    document.getElementById('revolut-payment-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        loadingOverlay.style.display = 'flex';
        
        const email = document.getElementById('revolut-email').value;
        const name = document.getElementById('revolut-name').value;

        if (!name || !email) {
            loadingOverlay.style.display = 'none';
            document.getElementById('revolut-errors').textContent = 'Please enter your name and email.';
            return;
        }

        const {error} = await stripe.confirmCardPayment('{{ client_secret }}', {
            payment_method: { 
                card: revolutCardField, 
                billing_details: { name: name, email: email } 
            }
        });
        
        if (error) {
            loadingOverlay.style.display = 'none';
            document.getElementById('revolut-errors').textContent = error.message;
        } else {
            window.location.href = '{% url "booking_success" booking.access_token %}';
        }
    });
    {% endif %}

    // Initialize PayPal
    {% if paypal_client_id %}
    paypal.Buttons({
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: '{{ booking.total_price }}',
                        currency_code: 'EUR'
                    },
                    description: '{{ booking.session.name }} - {{ booking.participants }} participants',
                    custom_id: '{{ booking.booking_reference }}'
                }]
            });
        },
        onApprove: function(data, actions) {
            loadingOverlay.style.display = 'flex';
            return actions.order.capture().then(function(details) {
                window.location.href = '{% url "booking_success" booking.access_token %}';
            });
        },
        onError: function(err) {
            alert('PayPal payment failed. Please try again or use a different payment method.');
            console.error(err);
        },
        style: {
            layout: 'vertical',
            color: 'blue',
            shape: 'rect',
            label: 'pay'
        }
    }).render('#paypal-button-container');
    {% endif %}
});
</script>
{% endblock %}